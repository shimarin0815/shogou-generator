<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <meta name="description" content="åå‰ã‚’å…¥ã‚Œã‚‹ã ã‘ã§ã€ä¸–ç•Œä¸€ãã ã‚‰ãªã„â—¯â—¯ãƒã‚¹ã‚¿ãƒ¼ã€ã¿ãŸã„ãªç§°å·ã‚’è‡ªå‹•ç”Ÿæˆï¼ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§Xã«ã‚·ã‚§ã‚¢ã§ãã¾ã™ã€‚" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas for image download -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- Emoji / Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Zen+Kaku+Gothic+New:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --grad-from:#fda4af; /* pink-300 */
      --grad-to:#fde68a;   /* amber-200 */
      --card-accent:#0ea5e9; /* sky-500 */
    }
    .font-main{font-family:"Zen Kaku Gothic New","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .shine{position:relative;overflow:hidden}
    .shine:after{content:"";position:absolute;inset:-100% -50%;background:linear-gradient(120deg,transparent 30%,rgba(255,255,255,.35),transparent 70%);transform:translateX(-100%);}
    .shine:hover:after{animation:shine 1.2s forwards}
    @keyframes shine{to{transform:translateX(100%)}}
  </style>
</head>
<body class="font-main min-h-screen bg-gradient-to-br from-[var(--grad-from)] to-[var(--grad-to)] flex items-center justify-center p-6">
  <main class="w-full max-w-2xl">
    <section class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-extrabold drop-shadow-sm">ã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ ğŸ†</h1>
      <p class="mt-2 text-slate-800/80">åå‰ã‚’å…¥ã‚Œã¦ã€ä¸–ç•Œã«ã²ã¨ã¤ã®â€œãã ã‚‰ãªã„ç§°å·â€ã‚’ä½œã‚ã†ï¼</p>
    </section>

    <section class="bg-white/80 backdrop-blur rounded-3xl shadow-xl p-5 md:p-6">
      <div class="flex flex-col md:flex-row gap-3 md:gap-4 items-stretch">
        <input id="nameInput" type="text" inputmode="kana-name" placeholder="ä¾‹ï¼šã—ã¾ã‚Šã‚“ / Shimarin"
               class="flex-1 rounded-2xl border border-slate-300 px-4 py-3 text-lg focus:ring-2 focus:ring-sky-400 focus:outline-none">
        <button id="genBtn" class="shine rounded-2xl px-5 py-3 text-white font-bold text-lg bg-sky-500 hover:bg-sky-600 active:scale-[.99] transition">ç§°å·ã‚’ç”Ÿæˆï¼</button>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="shuffleTheme" class="rounded-xl px-3 py-2 text-sm bg-slate-900 text-white/95 hover:bg-slate-800">ãƒ†ãƒ¼ãƒã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
        <button id="randomName" class="rounded-xl px-3 py-2 text-sm bg-slate-200 hover:bg-slate-300">ã‚µãƒ³ãƒ—ãƒ«ã§è©¦ã™</button>
      </div>

      <!-- Result Card -->
      <div id="resultWrap" class="mt-6 hidden">
        <div id="card" class="mx-auto w-full max-w-xl rounded-3xl shadow-2xl bg-white p-6 md:p-8 text-center border-4" style="border-color: var(--card-accent);">
          <div class="text-xs uppercase tracking-widest text-slate-500">æœ¬æ—¥ã®ç§°å·</div>
          <h2 id="titleText" class="mt-2 text-2xl md:text-3xl font-black leading-tight">
            ä¸–ç•Œä¸€ãã ã‚‰ãªã„â—¯â—¯ãƒã‚¹ã‚¿ãƒ¼
          </h2>
          <div class="mt-3 text-slate-600">æä¾›ï¼šã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <a id="xShare" target="_blank" rel="noopener" class="shine flex items-center justify-center gap-2 rounded-2xl bg-black text-white py-3 font-bold hover:opacity-90">
            <span>ğ• ã§ã‚·ã‚§ã‚¢</span>
          </a>
          <button id="copyText" class="rounded-2xl bg-white border border-slate-300 py-3 font-bold hover:bg-slate-50">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="dlImage" class="rounded-2xl bg-white border border-slate-300 py-3 font-bold hover:bg-slate-50">ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ä¿å­˜</button>
        </div>

        <details class="mt-4 bg-slate-50 rounded-2xl p-4">
          <summary class="cursor-pointer font-bold">ãŠã™ã™ã‚æŠ•ç¨¿ä¾‹ & ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</summary>
          <div class="mt-3 text-sm leading-relaxed" id="captionBox"></div>
        </details>
      </div>
    </section>

    <footer class="text-center mt-6 text-xs text-slate-800/70">
      Â© 2025 ã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ â€” made for fun
    </footer>
  </main>

<script>
// ====== Utility ======
const $ = (s)=>document.querySelector(s);
const rand = (arr)=>arr[Math.floor(Math.random()*arr.length)];
function hashCode(str){let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0}return Math.abs(h)}

// ====== Data ======
const patterns = [
  "ä¸–ç•Œä¸€ãã ã‚‰ãªã„{n}ãƒã‚¹ã‚¿ãƒ¼",
  "å†·è”µåº«ã®{n}ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³",
  "æ°¸é ã®{n}ç•ªé•·",
  "ä¼èª¬ã®{n}ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼",
  "å¯èµ·ãã®{n}ä»™äºº",
  "ã‚³ãƒ³ãƒ“ãƒ‹ã®{n}å‹‡è€…",
  "äººé¡æœ€å¾Œã®{n}ãƒãƒ³ã‚¿ãƒ¼",
  "è‡ªç§°{n}åšå£«",
  "ä¸‰æ—¥åŠä¸»ã®{n}ç‹",
  "æ­©ã{n}å›³é‘‘",
  "éå…¬èª{n}ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼",
  "ç©¶æ¥µã®{n}ã‚½ãƒ ãƒªã‚¨",
  "ç¤¾ä¼šã«ã‚„ã•ã—ã„{n}ç ´å£Šç¥",
  "ä»Šæ—¥ã ã‘ã®{n}ç·ç›£ç£",
  "çœŸå¤œä¸­ã®{n}è©•è«–å®¶",
  "ä»¤å’Œã®{n}é­”è¡“å¸«",
];

const sampleNames = ["ã—ã¾ã‚Šã‚“","ãŸãªã‹","ãƒã‚³","ã‚­ãƒ£ãƒ™ãƒ„","è¬ã®ç”Ÿå‘½ä½“","Shimarin","Taro","Yamada"];

const captionTemplates = [
  "ä»Šæ—¥ã®ç§°å·ï¼šã€{title}ã€\nå½“ãŸã£ã¦ã‚‹ï¼Ÿ #ã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼",
  "è¨ºæ–­çµæœï¼š{title} â€” åè«–ã¯å—ã‘ä»˜ã‘ã¾ã™ #ã—ã‚‡ã†ã‚‚ãªã„ç§°å· #ãƒã‚¿ã‚¢ãƒ—ãƒª",
  "ãŸã¶ã‚“å…¬å¼ã‚ˆã‚Šä¿¡ç”¨ã§ããªã„ç§°å·â†’ {title} #éŠã‚“ã§ã¿ãŸ",
  "åº—å†…ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ï¼š{title} æ§˜ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ˆï¼Ÿï¼‰ #ã—ã‚‡ã†ã‚‚ãªã„ç§°å·",
];

const hashtagCandidates = [
  "#ã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼",
  "#ã—ã‚‡ã†ã‚‚ãªã„ç§°å·",
  "#ãƒã‚¿ã‚¢ãƒ—ãƒª",
  "#è¨ºæ–­ãƒ¡ãƒ¼ã‚«ãƒ¼é¢¨",
  "#æš‡ã¤ã¶ã—",
];

// ====== Theme Shuffle ======
const themes = [
  {from:'#fda4af', to:'#fde68a', accent:'#0ea5e9'}, // pink->amber
  {from:'#93c5fd', to:'#a7f3d0', accent:'#8b5cf6'}, // blue->mint, violet accent
  {from:'#fbcfe8', to:'#cffafe', accent:'#f59e0b'}, // pink->cyan, amber accent
  {from:'#c4b5fd', to:'#f5d0fe', accent:'#10b981'}, // violet->pink, emerald accent
  {from:'#fecaca', to:'#fef08a', accent:'#ef4444'}, // rose->yellow, red accent
];
function applyTheme(theme){
  document.documentElement.style.setProperty('--grad-from', theme.from);
  document.documentElement.style.setProperty('--grad-to', theme.to);
  document.documentElement.style.setProperty('--card-accent', theme.accent);
}

// ====== Title Generation ======
function makeTitle(name){
  if(!name) return '';
  // ensure some determinism so sameåå‰ã§ã‚‚ä¼¼ãŸé›°å›²æ°—ã«
  const h = hashCode(name);
  const pattern = patterns[h % patterns.length];
  // ã‹ãªãƒ»ã‚«ãƒŠãƒ»è‹±å­—æ··åœ¨OK
  const n = name.trim();
  return pattern.replaceAll('{n}', n);
}

function buildTweetUrl(text){
  const params = new URLSearchParams({ text });
  // NOTE: URLã¯çœç•¥ï¼ˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°URLãŒæ±ºã¾ã£ãŸã‚‰ &url= ã‚’è¿½åŠ ï¼‰
  return `https://twitter.com/intent/tweet?${params.toString()}`;
}

function updateCaptionSuggestions(title){
  const box = $('#captionBox');
  const list = captionTemplates.map(t=>`â€¢ ${t.replace('{title}', title)}`).join('<br/>');
  const tags = hashtagCandidates.join(' ');
  box.innerHTML = `${list}<br/><br/><b>æ¨ã—ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼š</b><br/>${tags}`;
}

// ====== Image Download ======
async function downloadCardImage(){
  const node = document.getElementById('card');
  const canvas = await html2canvas(node, {backgroundColor:null, scale:2});
  canvas.toBlob((blob)=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'shogou-card.png';
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

// ====== URL Params (shareable) ======
function canReplaceState(){
  // Avoid SecurityError in sandboxed/unsupported schemes (about:, data:, blob:)
  try {
    const proto = location.protocol; // e.g. 'https:' or 'about:'
    if (!('replaceState' in history)) return false;
    if (proto === 'about:' || proto === 'data:' || proto === 'blob:') return false;
    return true;
  } catch { return false; }
}

function readParams(){
  try {
    const url = new URL(location.href);
    const name = url.searchParams.get('name') || sessionStorage.getItem('lastName') || '';
    return {name};
  } catch {
    // Fallback if URL API not available
    const name = sessionStorage.getItem('lastName') || '';
    return {name};
  }
}

function writeParams(name){
  // Update the query string if permitted; otherwise no-op (store to sessionStorage as a soft fallback)
  try {
    const url = new URL(location.href);
    url.searchParams.set('name', name);
    if (canReplaceState()) {
      history.replaceState(null, '', url.toString());
    } else {
      try { sessionStorage.setItem('lastName', name); } catch {}
    }
  } catch {
    try { sessionStorage.setItem('lastName', name); } catch {}
  }
}

// ====== Events ======
function generate(){
  const name = $('#nameInput').value.trim();
  if(!name){alert('åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼');return}
  const title = makeTitle(name);
  $('#titleText').textContent = title;
  $('#resultWrap').classList.remove('hidden');
  const tweetText = `${title}  #ã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼`;
  $('#xShare').setAttribute('href', buildTweetUrl(tweetText));
  updateCaptionSuggestions(title);
  writeParams(name);
}

$('#genBtn').addEventListener('click', generate);
$('#nameInput').addEventListener('keydown', e=>{ if(e.key==='Enter') generate(); });
$('#randomName').addEventListener('click', ()=>{ $('#nameInput').value = rand(sampleNames); generate(); });
$('#shuffleTheme').addEventListener('click', ()=>{ applyTheme(rand(themes)); });
$('#copyText').addEventListener('click', ()=>{
  const t = $('#titleText').textContent;
  navigator.clipboard.writeText(`${t} #ã—ã‚‡ã†ã‚‚ãªã„ç§°å·ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼`).then(()=>{
    $('#copyText').textContent='ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    setTimeout(()=>$('#copyText').textContent='ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼',1200);
  });
});
$('#dlImage').addEventListener('click', downloadCardImage);

// ====== Init ======
applyTheme(themes[0]);
const init = readParams();
if(init.name){
  $('#nameInput').value = init.name;
  generate();
}

// ====== Self Tests (non-intrusive; console only) ======
(function selfTests(){
  console.group('%cSelf-tests','color:#10b981;font-weight:bold');
  try {
    // 1) hashCode determinism
    console.assert(hashCode('ABC')===hashCode('ABC'), 'hashCode should be deterministic');
    console.assert(hashCode('ABC')!==hashCode('ABD'), 'hashCode should vary with input');

    // 2) makeTitle behavior
    const t1 = makeTitle('ã—ã¾ã‚Šã‚“');
    const t2 = makeTitle('ã—ã¾ã‚Šã‚“');
    console.assert(t1 && t1===t2, 'makeTitle should be deterministic for same name');
    console.assert(!makeTitle(''), 'makeTitle("") should return empty string');

    // 3) URL handling should not throw in sandbox
    const before = location.search;
    writeParams('ãƒ†ã‚¹ãƒˆ'); // should not throw regardless of environment
    const can = (location.protocol!=='about:' && location.protocol!=='data:' && location.protocol!=='blob:');
    console.assert(canReplaceState()===can, 'canReplaceState should reflect protocol support');

    // 4) readParams should return something (string)
    const rp = readParams();
    console.assert(typeof rp.name==='string', 'readParams.name should be a string');
  } catch (e) {
    console.error('Self-tests error:', e);
  }
  console.groupEnd();
})();
</script>
</body>
</html>
